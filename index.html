<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Stress Level Checker</title>

    <!-- Connect the CSS files CSSファイルを接続する -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <link rel="stylesheet" href="style.css">
</head>

<body>
    <!--Navbar ナビゲーションバー-->
    <div class="bg-dark text-white p-3">
        <div class="navtop d-flex justify-content-between align-items-center">
            <div class="navtitle">
                Stress Level Checker
            </div>
            <div>
                <i class="fa fa-refresh" aria-hidden="true" onClick="window.location.reload()"></i>
            </div>
        </div>
    </div>

    <!--Place to upload the file ファイルをアップロードする場所-->
    <div class="container-fluid mt-3 col-lg-8">

        <div class="card" id="uploadCard">
            <div class="card-header bg-dark text-bg-dark d-flex justify-content-between align-content-center">
                <span> CSV をアップロードしてストレス レベルを確認します。 </span><span><i class="fa fa-upload" aria-hidden="true"></i></span>
            </div>
            <div class="card-body bg-grey">
                <div class="input-group mb-3">
                    <input type="file" class="form-control" id="loadBtn">
                </div>

            </div>
        </div>

        <!--絵文字-->
        <div class="stressResult text-center" id="goodStress">
            <i class="fa fa-smile-o" aria-hidden="true"></i>
        </div>

        <div class="stressResult text-center" id="medStress">
            <i class="fa fa-meh-o" aria-hidden="true"></i>
        </div>

        <div class="stressResult text-center" id="badStress">
            <i class="fa fa-frown-o" aria-hidden="true"></i>
        </div>
        <!--Display average stress result 平均ストレスレベル結果を表示-->
        <div class="mt-3" id="average">
        </div>



        <div id="chartTitle" class="mt-2 text-center">
            このグラフは、最新の 50 件のストレス エントリを示しています。
        </div>


        <!--Display chart グラフを表示-->
        <div>
            <canvas id="myChart"></canvas>
        </div>

        <!--Display chart グラフを表示-->


        <!--Display chart ストレスレベルを下げる方法を表示-->

        <!--良い結果-->
        <div class="card mt-3 mb-3" id="goodStressRec">
            <div class="card-header bg-success text-white d-flex justify-content-between align-content-center">
                <span>ストレスレベルを下げる方法</span>
                <span><i class="fa fa-heart" aria-hidden="true"></i></span>
            </div>
            <div class="card-body bg-lg-grn">
                <h5 class="card-title">Your stress level is normal <i class="fa fa-smile-o" aria-hidden="true"></i>
                </h5>
                <p class="card-text">If you want to lower your stress level, consider the following activities:</p>
                <ul>
                    <li>Take a walk everyday</li>
                    <li>Take a walk everyday</li>
                    <li>Take a walk everyday</li>
                </ul>
            </div>
        </div>

        <!--中結果-->
        <div class="card mt-3 mb-3" id="medStressRec">
            <div class="card-header bg-warning text-black d-flex justify-content-between align-content-center">
                <span>ストレスレベルを下げる方法</span>
                <span><i class="fa fa-heart" aria-hidden="true"></i></span>
            </div>
            <div class="card-body">
                <h5 class="card-title">Your stress level is a little high. <i class="fa fa-meh-o"
                        aria-hidden="true"></i></h5>
                <p class="card-text">If you want to lower your stress level, consider the following activities:</p>
                <ul>
                    <li>Take a walk everyday</li>
                    <li>Take a walk everyday</li>
                    <li>Take a walk everyday</li>
                </ul>
            </div>
        </div>

        <!--悪い結果-->
        <div class="card mt-3 mb-3" id="badStressRec">
            <div class="card-header bg-danger text-white d-flex justify-content-between align-content-center">
                <span>ストレスレベルを下げる方法</span>
                <span><i class="fa fa-heart" aria-hidden="true"></i></span>
            </div>
            <div class="card-body">
                <h5 class="card-title">Your stress level is high. <i class="fa fa-frown-o" aria-hidden="true"></i></h5>
                <p class="card-text">If you want to lower your stress level, consider the following activities:</p>
                <ul>
                    <li>Take a walk everyday</li>
                    <li>Take a walk everyday</li>
                    <li>Take a walk everyday</li>
                </ul>
            </div>
        </div>
        <div>
            <canvas id="myChart2"></canvas>
        </div>
    </div>

    <!--Import the scripts for the graph and parsing the timestamp. グラフのスクリプトをインポートし、タイムスタンプを解析する。-->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!--https://moment.github.io/luxon/#/-->
    <script src="moment.js"></script>

    <script>
        //Average Stress　平均ストレス
        var avgStress = document.getElementById("average");

        //File upload and button　ファイルのアップロードとボタン
        var theCard = document.getElementById("uploadCard");
        var loadBtn = document.querySelector("#loadBtn");

        //絵文字
        var badStress = document.getElementById("badStress");
        var medStress = document.getElementById("medStress");
        var goodStress = document.getElementById("goodStress");

        //Chart title　グラフタイトル
        var chartTitle = document.getElementById("chartTitle");

        //Recommendations　ストレスレベルを下げる方法
        var goodStressRec = document.getElementById("goodStressRec");
        var badStressRec = document.getElementById("badStressRec");
        var medStressRec = document.getElementById("medStressRec");

        loadBtn.addEventListener("change", upload, false);

        //Array to hold the stress data as an object　ストレスデータをオブジェクトとして保持する配列。
        resArr = [];
        resObj = {};

        //https://the-zombis.sakura.ne.jp/wp/blog/2019/08/17/post-3938/
        function upload(event) {
            theCard.style.display = "none";
            // 2：checkFileReader関数でFileAPIにブラウザが対応してるかチェック
            if (!checkFileReader()) {
                alert("エラー：FileAPI非対応のブラウザです。");
            } else {
                // 3: 選択されたファイル情報を取得
                var file = event.target.files[0];
                var type = file.type; // MIMEタイプ
                var size = file.size; // ファイル容量（byte）
                var limit = 10000; // byte, 10KB

                // MIMEタイプの判定
                if (type == "image/jpeg") {
                    alert("画像はアップロードできません");
                    loadBtn.value = "";
                    return;
                }

                //readerオブジェクトを作成
                var reader = new FileReader();
                // ファイル読み取りを実行
                reader.readAsText(file);

                // 4：CSVファイルを読み込む処理とエラー処理をする
                reader.onload = function (event) {
                    var result = event.target.result;
                    makeCSV(result);
                };

                //読み込めなかった場合のエラー処理
                reader.onerror = function () {
                    alert("エラー：ファイルをロードできません。");
                };
            }
        }

        //csvをうまく出力する
        function makeCSV(csvdata) {
            //csvデータを1行ごとに配列にする
            var tmp = csvdata.split("\n");

            //Extract the stress data ストレスデータを抽出する
            tmp.forEach(i => {
                resObj = {};
                var original = i;
                if (i.includes("stress") && !i.includes("single")) {
                    arr = i.split(`""time"":`);
                    arr.shift();
                    i = arr.join("}");
                    i = i.substring(0, i.length - 27);

                    //parse the time value 時間値を解析する
                    var unixSeconds = (i).toString();
                    var unixMilliSeconds = unixSeconds * 1000;
                    var myDate = new Date(unixMilliSeconds);
                    myDate = moment(myDate).format('YY/MM/DD HH:mm');

                    //parse the stress value 応力値を解析する
                    original = original.substring(0, original.length - 13);
                    arr = original.split(`""stress"":`);
                    arr.shift();
                    original = arr.join("}");

                    var myValue = original;

                    resObj.time = myDate;
                    resObj.value = myValue;

                    //push the data to the array 配列にデータをプッシュする
                    resArr.push(resObj);
                }
            });

            //get the last 50 entries 直近の50件を取得する
            const last50 = resArr.slice(-50);
            console.log(last50);

            //calculate average stress level 平均ストレスレベルを計算する
            const findAverageStress = (arr) => {
                const {
                    length
                } = arr;
                return arr.reduce((acc, val) => {
                    return acc + (val.value / length);
                }, 0);
            };
            var avgStressLvl = findAverageStress(resArr);
            avgStressLvl = (Math.round(avgStressLvl));

            //get highest stress level　最高のストレスレベルを得る
            let maxStress = resArr.reduce((max, stresslv) => max.value > stresslv.value ? max : stresslv);
            console.log(maxStress)

            //get lowest stress level　最低のストレスレベルを得る
            let leastStress = resArr.reduce((max, stresslv) => max.value < stresslv.value ? max : stresslv);
            console.log(leastStress)

            //display the result 結果を表示する

            //good result 良い結果
            if (avgStressLvl < 45) {
                goodStress.style.display = "block";
                goodStressRec.style.display = "block";
                avgStress.classList.add("alert-success");
                avgStress.innerHTML +=
                "<div class='alert alert-success text-center' role='alert'><strong>平均ストレスレベルは<span class='avgnum'>「" + avgStressLvl + "」</span>です。</strong></div><div class='row'><div class='col-6'><div class='card text-center'><div class='card-header bg-cardok'>最低値</div><div class='card-body'><h3 class='card-text'>"+leastStress.value +" </h3></div><div class='card-footer text-body-secondary'>"+leastStress.time +" </div></div></div><div class='col-6'><div class='card text-center'><div class='card-header bg-cardbad'>最高値</div><div class='card-body'><h3 class='card-text'>"+maxStress.value +" </h3></div><div class='card-footer text-body-secondary'>"+maxStress.time +" </div></div></div></div>"

                //Medium result 中位結果
            } else if (avgStressLvl >= 45 && avgStressLvl < 60) {
                medStress.style.display = "block";
                medStressRec.style.display = "block";
                avgStress.classList.add("alert-warning");
                avgStress.innerHTML +=
                    "<div class='card mb-3'><div class='card-header text-black bg-warning text-center'><strong>平均ストレスレベルは" +
                    avgStressLvl +
                    "です。</strong></div><div class='card-body bg-lg-yel'><ul><li>ストレスレベルの最低値は " + leastStress.time +
                    " の「" + leastStress.value + "」でした。<li>ストレスレベルの最高値は " + maxStress.time + " の「" + maxStress.value +
                    "」でした。</li></ul><div class='text-center'>ストレスレベルを下げる方法については、<a href='#midStressRec'>以下をご覧ください。</a></div></div></div>";

                //bad result 悪い結果
            } else {
                badStress.style.display = "block";
                badStressRec.style.display = "block";
                avgStress.classList.add("alert-danger");
                avgStress.innerHTML +=
                    "<div class='card mb-3'><div class='card-header text-white bg-danger text-center'><strong>平均ストレスレベルは" +
                    avgStressLvl +
                    "です。</strong></div><div class='card-body bg-lg-red'><ul><li>ストレスレベルの最低値は " + leastStress.time +
                    " の「" + leastStress.value + "」でした。<li>ストレスレベルの最高値は " + maxStress.time + " の「" + maxStress.value +
                    "」でした。</li></ul><div class='text-center'>ストレスレベルを下げる方法については、<a href='#badStressRec'>以下をご覧ください。</a></div></div></div>";
            }

            const green = [];
            const yellow = [];
            const red = [];


            for (i = 0; i < resArr.length; i++) {
                if (resArr[i].value < 45) {
                    green.push(resArr[i]);
                } else if (resArr[i].value >= 45 && resArr[i].value < 60) {
                    yellow.push(resArr[i]);
                } else {
                    red.push(resArr[i]);
                }
            }

            const greenyellowred = green.concat(yellow, red);

            greenyellowred.sort(function (a, b) {
                var keyA = a.value,
                    keyB = b.value;
                // Compare the 2 dates
                if (keyA < keyB) return -1;
                if (keyA > keyB) return 1;
                return 0;
            });

            console.log(greenyellowred);

            //直近の50件をグラフに表示する。
            var labels = last50.map(function (e) {
                return e.time;
            });
            var data = last50.map(function (e) {
                return e.value;
            });

            //set the colour of the chart points based on the value 値に基づいてグラフポイントの色を設定する。
            const ctx = document.getElementById('myChart');
            const ctx2 = document.getElementById('myChart2');

            const backgroundColor = [];

            for (i = 0; i < data.length; i++) {
                if (data[i] < 45) {
                    backgroundColor.push("rgba(127, 194, 110, 1)");
                } else if (data[i] >= 45 && data[i] < 60) {
                    backgroundColor.push("rgba(255, 169, 87, 1)");
                } else {
                    backgroundColor.push("rgba(236, 82, 74, 1)");
                }
            }


            //display the chart グラフを表示
            //https://www.chartjs.org/
            chartTitle.style.display = "block";

            var config = {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ストレスレベル',
                        data: data,
                        backgroundColor: backgroundColor,
                        borderWidth: 1,
                        pointStyle: 'rectRounded',
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        borderColor: "rgba(0, 0, 0, 0.29)",
                        tension: 0.2,

                    }]
                },
                options: {
                    plugins: {
                        legend: {
                            display: false,
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                maxTicksLimit: 10
                            }
                        }
                    }
                }
            };

            const backgroundColor2 = [];

            for (i = 0; i < greenyellowred.length; i++) {
                if (greenyellowred[i].value < 45) {
                    backgroundColor2.push("rgba(127, 194, 110, 1)");
                } else if (greenyellowred[i].value >= 45 && greenyellowred[i].value < 60) {
                    backgroundColor2.push("rgba(255, 169, 87, 1)");
                } else {
                    backgroundColor2.push("rgba(236, 82, 74, 1)");
                }
            }

            var chart = new Chart(ctx, config);

            var config2 = {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ストレスレベル',
                        data: greenyellowred,
                        backgroundColor: backgroundColor2,
                        borderWidth: 0,
                        borderColor: backgroundColor2,
                    }]
                },
                options: {
                    plugins: {
                        legend: {
                            display: false,
                        }
                    },
                }
            };

            var chart2 = new Chart(ctx2, config2);

        }









        // ファイルアップロード判定
        function checkFileReader() {
            var isUse = false;
            if (window.File && window.FileReader && window.FileList && window.Blob) {
                isUse = true;
            }
            return isUse;
        }
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
        integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous">
    </script>

</body>

</html>