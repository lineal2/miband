<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Stress Level Checker</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="bg-dark text-white p-3">
        <div class="navtop d-flex justify-content-between align-items-center">
            <div class="navtitle">
                Stress Level Checker
            </div>
            <div>
                <i class="fa fa-refresh" aria-hidden="true" onClick="window.location.reload()"></i>
            </div>
        </div>
    </div>

    <div class="container-fluid mt-3 col-lg-8">

        <div class="card" id="uploadCard">
            <div class="card-header text-center bg-dark text-bg-dark">
                CSV をアップロードしてストレス レベルを確認します。 </div>
            <div class="card-body bg-grey">
                <div class="input-group mb-3">
                    <input type="file" class="form-control" id="loadBtn">
                </div>

                <!-- <input type="file" name="select" id="loadBtn" /> -->
                <div id="resulttable"></div>
            </div>
        </div>

        <div class="stressResult text-center" id="goodStress">
            <i class="fa fa-smile-o" aria-hidden="true"></i>
        </div>

        <div class="stressResult text-center" id="medStress">
            <i class="fa fa-meh-o" aria-hidden="true"></i>
        </div>

        <div class="stressResult text-center" id="badStress">
            <i class="fa fa-frown-o" aria-hidden="true"></i>
        </div>
        <div class="alert mt-3 text-center" id="average" role="alert">
        </div>
       <div id="chartTitle" class="mt-2 text-center">
            このグラフは、最新の 50 件のストレス エントリを示しています。
        </div>
        <div>
            <canvas id="myChart"></canvas>
        </div>

        <div class="card mt-3 mb-3" id="goodStressRec">
            <div class="card-header bg-success text-white">
              Recommended Activities to Reduce Stress
            </div>
            <div class="card-body bg-lg-grn">
              <h5 class="card-title">Your stress level is normal.</h5>
              <p class="card-text">If you want to lower your stress level, consider the following activities:</p>
              <ul>
                <li>Take a walk everyday</li>
                <li>Take a walk everyday</li>
                <li>Take a walk everyday</li>
              </ul>
            </div>
          </div>

          <div class="card mt-3 mb-3" id="medStressRec">
            <div class="card-header bg-warning text-black">
              Recommended Activities to Reduce Stress
            </div>
            <div class="card-body">
              <h5 class="card-title">Your stress level is a little high.</h5>
              <p class="card-text">If you want to lower your stress level, consider the following activities:</p>
              <ul>
                <li>Take a walk everyday</li>
                <li>Take a walk everyday</li>
                <li>Take a walk everyday</li>
              </ul>
            </div>
          </div>

          <div class="card mt-3 mb-3" id="badStressRec">
            <div class="card-header bg-danger text-white">
              Recommended Activities to Reduce Stress
            </div>
            <div class="card-body">
              <h5 class="card-title">Your stress level is high.</h5>
              <p class="card-text">If you want to lower your stress level, consider the following activities:</p>
              <ul>
                <li>Take a walk everyday</li>
                <li>Take a walk everyday</li>
                <li>Take a walk everyday</li>
              </ul>
            </div>
          </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="moment.js"></script>



    <script>
        //Average Stress
        var avgStress = document.getElementById("average");

        //File upload and button
        var theCard = document.getElementById("uploadCard");
        var loadBtn = document.querySelector("#loadBtn");

        //絵文字
        var badStress = document.getElementById("badStress");
        var medStress = document.getElementById("medStress");
        var goodStress = document.getElementById("goodStress");

        //Chart title
        var chartTitle = document.getElementById("chartTitle");

        //Recommendations
        var goodStressRec = document.getElementById("goodStressRec");
        var badStressRec = document.getElementById("badStressRec");
        var medStressRec = document.getElementById("medStressRec");

        loadBtn.addEventListener("change", upload, false);

        //Array to hold the stress data as an object
        resArr = [];
        resObj = {};

        function upload(event) {
            theCard.style.display = "none";
            // 2：chekFileReader関数でFileAPIにブラウザが対応してるかチェック
            if (!checkFileReader()) {
                alert("エラー：FileAPI非対応のブラウザです。");
            } else {
                // 3: 選択されたファイル情報を取得
                var file = event.target.files[0];
                var type = file.type; // MIMEタイプ
                var size = file.size; // ファイル容量（byte）
                var limit = 10000; // byte, 10KB

                // MIMEタイプの判定
                if (type == "image/jpeg") {
                    alert("画像はアップロードできません");
                    loadBtn.value = "";
                    return;
                }

                //readerオブジェクトを作成
                var reader = new FileReader();
                // ファイル読み取りを実行
                reader.readAsText(file);

                // 4：CSVファイルを読み込む処理とエラー処理をする
                reader.onload = function (event) {
                    var result = event.target.result;
                    makeCSV(result);
                };

                //読み込めなかった場合のエラー処理
                reader.onerror = function () {
                    alert("エラー：ファイルをロードできません。");
                };
            }
        }

        //csvをうまく出力する
        function makeCSV(csvdata) {
            //csvデータを1行ごとに配列にする
            var tmp = csvdata.split("\n");

            tmp.forEach(i => {
                resObj = {};
                var original = i;
                if (i.includes("stress") && !i.includes("single")) {
                    arr = i.split(`""time"":`);
                    arr.shift();
                    i = arr.join("}");
                    i = i.substring(0, i.length - 27);

                    //parse the time value 時間値を解析する
                    var unixSeconds = (i).toString();
                    var unixMilliSeconds = unixSeconds * 1000;
                    var myDate = new Date(unixMilliSeconds);
                    myDate = moment(myDate).format('DD/MM/YY HH:mm');

                    //parse the stress value 応力値を解析する
                    original = original.substring(0, original.length - 13);
                    arr = original.split(`""stress"":`);
                    arr.shift();
                    original = arr.join("}");

                    var myValue = original;

                    resObj.time = myDate;
                    resObj.value = myValue;

                    resArr.push(resObj);

                }
            });

            //  get the last 50 entries 直近の50件を取得する
            const last50 = resArr.slice(-50);
            console.log(last50);

            //calculate average stress level 平均ストレスレベルを計算する
            const findAverageStress = (arr) => {
                const {
                    length
                } = arr;
                return arr.reduce((acc, val) => {
                    return acc + (val.value / length);
                }, 0);
            };
            var avgStressLvl = findAverageStress(resArr);
            avgStressLvl = (Math.round(avgStressLvl));

            if (avgStressLvl < 45) {
                goodStress.style.display = "block";
                goodStressRec.style.display = "block";
                avgStress.classList.add("alert-success");
                avgStress.innerHTML += "平均ストレスレベルは" + avgStressLvl + "です。";

            } else if (avgStressLvl >= 45 && avgStressLvl < 60) {
                medStress.style.display = "block";
                medStressRec.style.display = "block";
                avgStress.classList.add("alert-warning");
                avgStress.innerHTML += "平均ストレスレベルは" + avgStressLvl + "です。";

            } else {
                badStress.style.display = "block";
                badStressRec.style.display = "block";
                avgStress.classList.add("alert-danger");
                avgStress.innerHTML += "平均ストレスレベルは" + avgStressLvl + "です。";
            }

            //直近の50件をグラフに表示する。
            var labels = last50.map(function (e) {
                return e.time;
            });
            var data = last50.map(function (e) {
                return e.value;
            });

            const ctx = document.getElementById('myChart');

            const backgroundColor = [];


            for (i = 0; i < data.length; i++) {
                if (data[i] < 45) {
                    backgroundColor.push("rgba(127, 194, 110, 1)");
                } else if (data[i] >= 45 && data[i] < 60) {
                    backgroundColor.push("rgba(255, 169, 87, 1)");
                } else {
                    backgroundColor.push("rgba(236, 82, 74, 1)");
                }
            }

            chartTitle.style.display = "block";

            var config = {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ストレスレベル',
                        data: data,
                        backgroundColor: backgroundColor,
                        borderWidth: 1,
                        pointStyle: 'rectRounded',
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        borderColor: "rgba(0, 0, 0, 0.29)",
                        tension: 0.2,

                    }]
                },
                options: {
                    plugins: {
                        legend: {
                            display: false,
                        }
                    }
                }
            };

            var chart = new Chart(ctx, config);
        }



        // ファイルアップロード判定
        function checkFileReader() {
            var isUse = false;
            if (window.File && window.FileReader && window.FileList && window.Blob) {
                isUse = true;
            }
            return isUse;
        }
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
        integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous">
    </script>

</body>

</html>